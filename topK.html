<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    
</body>
<script>
    ;(() => {
  /**
   * 功能：从数组中找出前 K 个最大值
   * 思路：构建一个小顶堆（堆顶是当前最小的数）
   *       当遇到比堆顶更大的元素时，替换堆顶并调整堆
   * 
   * 入口函数topK、整体构建小顶堆、局部构建、交换函数
   * 入口函数topK(前k个元素,arr)：先slice取前k个元素当作初始堆，然后用这个初始堆
   *    构建小顶堆
   *    随后遍历剩下的元素，从下标k开始，当前元素大于堆顶则替换堆顶，heapify一下
   * 整体构建小顶堆buildMinHeap(arr)：n/2-1节点开始，i--，调用heapify
   * 局部调整小顶堆heapify(arr,index根元素,heapSize)：
   *    smallest初始化为index，left=2index+1，right=2index+2
   *    如果left/right更小则smallest标记为left/right
   *    如果index不是最小的则交换下表为smallest和index的数，swap
   * 交换swap(arr,i,j)
   */

  const arr = [11, 1, 4, 7, 9, 3, 2, 8, 10, 44, 300, 67]

  // 入口函数
  function topK(k, arr) {
    // 1. 取出前 k 个元素作为初始堆
    let heapArr = arr.slice(0, k)
    buildMinHeap(heapArr) //调成小顶堆

    // 2. 遍历剩下的元素，维护小顶堆
    for (let i = k; i < arr.length; i++) {
      if (arr[i] > heapArr[0]) {
        heapArr[0] = arr[i] // 替换堆顶
        heapify(heapArr, 0, k) // 调整堆，重新保证堆顶是新的最小值
      }
    }

    return heapArr  //返回的 heapArr 是一个小顶堆，里面的元素就是：
    //整个数组里最大的 K 个数（顺序不一定排好）

  }

  // 构建小顶堆
  function buildMinHeap(arr) {
    const n = arr.length
    // 从最后一个非叶子节点开始往上调整
    //数组的最后一半节点（从 n/2 开始）都是叶子节点
    // 叶子节点天生就是小顶堆（因为它没有孩子）
    // 所以我们只需要从最后一个非叶子节点往上调整就行
    for (let i = Math.floor(n / 2) - 1; i >= 0; i--) {
      heapify(arr, i, n)
    }
  }

  // 调整堆，使以 index 为根的子树满足小顶堆性质
  function heapify(arr, index, heapSize) {
    let smallest = index
    const left = 2 * index + 1 //下标性质
    const right = 2 * index + 2

    //如果左子节点更小，则标记为 smallest
    if (left < heapSize && arr[left] < arr[smallest]) {
      smallest = left
    }
    if (right < heapSize && arr[right] < arr[smallest]) {
      smallest = right
    }
    //经过这两步，smallest 里存的就是当前这三个节点中最小的那个下标。

    // 如果父节点不是最小的（说明它比某个子节点大）：交换父节点和最小的子节点
    if (smallest !== index) {
      swap(arr, index, smallest)
      heapify(arr, smallest, heapSize) //递归调整
    }
  }

  // 交换两个元素
  function swap(arr, i, j) {
    const temp = arr[i]
    arr[i] = arr[j]
    arr[j] = temp
  }

  console.log(topK(4, arr))
})()

</script>
</html>