<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!-- start(),è¿”å›ä¸€ä¸ªpromiseï¼Œè°ƒç”¨runTask
            å¼€å§‹æ‰§è¡Œï¼Œæˆ–ä»æš‚åœæ¢å¤
            isRunningï¼Œè¿”å›æ­£åœ¨è¿è¡Œï¼›ispauseï¼Œåˆ™å¼€å§‹æ‰§è¡Œï¼ˆè°ƒrunTaskï¼‰ï¼Œæ”¹ispauseå’Œisrunningï¼Œ
            é¦–æ¬¡å¯åŠ¨ï¼Œåˆå§‹åŒ–ï¼Œ00ï¼ŒisRunning=trueï¼ŒisPause=falseï¼ŒresolveALLå’ŒrejectAllï¼Œç„¶årunTask
        pause
            å¦‚æœæ²¡æœ‰åœ¨isrunningï¼Œæš‚åœä¸äº†ï¼›å¦‚æœå·²ç»ispauseï¼Œè¿”å›å·²ç»æš‚åœï¼› å‰©ä¸‹çš„å°±æ˜¯ç›´æ¥æš‚åœ
        getStatus
            ç›´æ¥return å¯¹è±¡{æ€»å…±çš„ä»»åŠ¡æ•°ï¼Œå½“å‰æ‰§è¡Œåˆ°çš„ä»»åŠ¡æ•°ï¼Œå·²å®Œæˆçš„ä»»åŠ¡æ•°ï¼Œå¤±è´¥çš„ä»»åŠ¡æ•°ï¼ŒisRunningï¼ŒisPausedï¼Œç»“æœæ•°ç»„}
        executeTask(index)ï¼Œå› ä¸ºæ˜¯æ‰§è¡Œå•ä¸ªä»»åŠ¡æ‰€ä»¥è¦ä¼ ä¸€ä¸ªindex
            æ‰§è¡Œå•ä¸ªä»»åŠ¡ï¼ˆawait tasks[index]()ï¼‰å¹¶è®°å½•ç»“æœï¼šå­˜åˆ°results[index]é‡Œï¼Œåˆ†æˆåŠŸå’Œå¤±è´¥çŠ¶æ€ï¼Œå¤±è´¥çŠ¶æ€å°±throw error

        runTask(),asyncå‡½æ•°ï¼Œè°ƒç”¨executeTaskã€‚
            è´Ÿè´£æ‰§è¡Œæ•´ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œwhile(currentIndx<tasks.length)ï¼Œæ¯æ¬¡éƒ½çœ‹æ˜¯å¦pauseï¼Œæ˜¯çš„è¯å°±returnï¼Œ
            try catchæ‰§è¡ŒexecuteTask(currentIndex)ï¼Œè®°å¾—cuindexè¦++ï¼Œcatchéƒ¨åˆ†å°±æ˜¯å¤±è´¥ï¼ˆerror.messageï¼‰ï¼Œisrunningæ”¹ä¸ºfalseï¼Œæ‰§è¡ŒrejectAllåreturn
            æ•´ä½“whileå®Œæ¯•åisrunning=falseï¼Œæ‰§è¡ŒresolveAll
        -->
</body>
<script>
    /**
 * ä»»åŠ¡å¤„ç†å™¨ - é¡ºåºæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œæ”¯æŒæš‚åœå’Œæ¢å¤
 * @param {Array<Function>} tasks - ä»»åŠ¡åˆ—è¡¨ï¼Œæ¯ä¸ªä»»åŠ¡æ˜¯ä¸€ä¸ªè¿”å› Promise çš„å¼‚æ­¥å‡½æ•°
 * @returns {Object} è¿”å›åŒ…å« start å’Œ pause æ–¹æ³•çš„å¯¹è±¡
 */

function processTasks(tasks) {
    let currentIndex = 0;           // å½“å‰æ‰§è¡Œåˆ°çš„ä»»åŠ¡ç´¢å¼•
    let isPaused = false;           // æ˜¯å¦æš‚åœ
    let isRunning = false;          // æ˜¯å¦æ­£åœ¨è¿è¡Œ
    const results = [];             // å­˜å‚¨æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœ
    let resolveAll = null;          // ç”¨äº resolve æ‰€æœ‰ä»»åŠ¡å®Œæˆçš„ Promise
    let rejectAll = null;           // ç”¨äº reject ä»»åŠ¡æ‰§è¡Œå¤±è´¥çš„ Promise
    
    /**
     * æ‰§è¡Œå•ä¸ªä»»åŠ¡
     * @param {number} index - ä»»åŠ¡ç´¢å¼•
     */
    const executeTask = async (index) => {
        try {
            console.log(` å¼€å§‹æ‰§è¡Œä»»åŠ¡ ${index + 1}/${tasks.length}`);
            const startTime = Date.now();
            
            // æ‰§è¡Œä»»åŠ¡ï¼ˆä»»åŠ¡å…·æœ‰åŸå­æ€§ï¼Œä¸å¯ä¸­æ–­ï¼‰
            const result = await tasks[index]();
            
            const duration = Date.now() - startTime;
            console.log(`ä»»åŠ¡ ${index + 1} å®Œæˆï¼Œè€—æ—¶ ${duration}ms`);
            
            // å­˜å‚¨ç»“æœ
            results[index] = {
                index,
                success: true,
                result,
                duration
            };
            
            return result;
        } catch (error) {
            console.error(`ä»»åŠ¡ ${index + 1} å¤±è´¥:`, error.message);
            
            // å­˜å‚¨é”™è¯¯ä¿¡æ¯
            results[index] = {
                index,
                success: false,
                error: error.message,
                duration: 0
            };
            
            throw error;
        }
    };
    
    /**
     * æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—
     */
    const runTasks = async () => {
        while (currentIndex < tasks.length) {
            // æ£€æŸ¥æ˜¯å¦æš‚åœï¼ˆåœ¨ä¸¤ä¸ªä»»åŠ¡ä¹‹é—´æ£€æŸ¥ï¼‰
            if (isPaused) {
                console.log(` ä»»åŠ¡æš‚åœåœ¨ç¬¬ ${currentIndex + 1} ä¸ªä»»åŠ¡ä¹‹å‰`);
                return;
            }
            
            try {
                // æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼ˆåŸå­æ€§ï¼Œä¸å¯ä¸­æ–­ï¼‰
                await executeTask(currentIndex);
                currentIndex++;
            } catch (error) {
                // ä»»åŠ¡å¤±è´¥ï¼Œåœæ­¢æ‰§è¡Œ
                isRunning = false;

                //é˜²å¾¡å¼å†™æ³•ï¼Œé˜²æ­¢æ²¡åˆå§‹åŒ–
                if (rejectAll) {
                    rejectAll(error);
                }
                return;
            }
        }
        
        // æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        isRunning = false;
        console.log(`æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼å…± ${tasks.length} ä¸ªä»»åŠ¡`);
        
        if (resolveAll) {
            resolveAll(results);
        }
    };
    
    /**
     * å¯åŠ¨ä»»åŠ¡æ‰§è¡Œ
     * @returns {Promise} è¿”å›ä¸€ä¸ª Promiseï¼Œåœ¨æ‰€æœ‰ä»»åŠ¡å®Œæˆæ—¶ resolve
     */
    const start = () => {
        return new Promise((resolve, reject) => {
            if (isRunning && !isPaused) {
                console.warn(' ä»»åŠ¡å·²åœ¨è¿è¡Œä¸­');
                return;
            }
            
            // å¦‚æœæ˜¯æš‚åœçŠ¶æ€ï¼Œæ¢å¤æ‰§è¡Œ
            if (isPaused) {
                console.log(`æ¢å¤æ‰§è¡Œï¼Œä»ç¬¬ ${currentIndex + 1} ä¸ªä»»åŠ¡å¼€å§‹`);
                isPaused = false;
                isRunning = true;
                runTasks();
            } else {
                // é¦–æ¬¡å¯åŠ¨
                console.log(`å¼€å§‹æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ï¼Œå…± ${tasks.length} ä¸ªä»»åŠ¡`);
                currentIndex = 0;
                results.length = 0;
                isRunning = true;
                isPaused = false;
                
                resolveAll = resolve;
                rejectAll = reject;
                
                runTasks();
            }
        });
    };
    
    /**
     * æš‚åœä»»åŠ¡æ‰§è¡Œ
     * æ³¨æ„ï¼šåªèƒ½åœ¨ä¸¤ä¸ªä»»åŠ¡ä¹‹é—´æš‚åœï¼Œå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¼šå®Œæˆ
     */
    const pause = () => {
        //çœ‹isrunningå’Œispaused
        if (!isRunning) {
            console.warn('ä»»åŠ¡æœªåœ¨è¿è¡Œä¸­ï¼Œæ— æ³•æš‚åœ');
            return;
        }
        
        if (isPaused) {
            console.warn(' ä»»åŠ¡å·²ç»æš‚åœ');
            return;
        }
        
        isPaused = true;
        console.log('è¯·æ±‚æš‚åœä»»åŠ¡ï¼ˆå½“å‰ä»»åŠ¡å®Œæˆåæš‚åœï¼‰');
    };
    
    /**
     * è·å–å½“å‰çŠ¶æ€
     */
    const getStatus = () => {
        return {
            total: tasks.length,
            current: currentIndex,
            completed: results.filter(r => r && r.success).length,
            failed: results.filter(r => r && !r.success).length,
            //å¯¹è±¡é‡Œçš„ key åå’Œå˜é‡å å®Œå…¨ä¸€æ ·ï¼Œç®€å†™è¯­æ³•ç³–
            isRunning,
            isPaused,
            results: [...results]
        };
    };
    
    // è¿”å›æ§åˆ¶æ¥å£
    return {
        start,
        pause,
        getStatus  // é¢å¤–æä¾›çŠ¶æ€æŸ¥è¯¢æ–¹æ³•
    };
}


// ==================== ä½¿ç”¨ç¤ºä¾‹ ====================

/**
 * åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå¼‚æ­¥ä»»åŠ¡
 * @param {number} id - ä»»åŠ¡ ID
 * @param {number} duration - ä»»åŠ¡æ‰§è¡Œæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
 * @param {boolean} shouldFail - æ˜¯å¦æ¨¡æ‹Ÿå¤±è´¥
 */
function createTask(id, duration = 1000, shouldFail = false) {
    //è¿”å›ä¸€ä¸ªå¼‚æ­¥å‡½æ•°
    return async () => {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (shouldFail) {
                    reject(new Error(`ä»»åŠ¡ ${id} æ‰§è¡Œå¤±è´¥`));
                } else {
                    resolve(`ä»»åŠ¡ ${id} çš„ç»“æœ`);
                }
            }, duration);
        });
    };
}

// ==================== ç¤ºä¾‹ 1ï¼šåŸºæœ¬ä½¿ç”¨ ====================
async function example1() {
    console.log('\n========== ç¤ºä¾‹ 1ï¼šåŸºæœ¬ä½¿ç”¨ ==========\n');
    
    const tasks = [
        createTask(1, 1000),
        createTask(2, 800),
        createTask(3, 1200),
        createTask(4, 500),
        createTask(5, 900)
    ];
    
    const processor = processTasks(tasks);
    
    // å¯åŠ¨ä»»åŠ¡
    //ä¸åŠ  await â†’ å¾—åˆ°çš„æ˜¯ Promise å¯¹è±¡ï¼›
    //åŠ äº† await â†’ å¾—åˆ°çš„æ˜¯ Promise è§£æåçš„å®é™…ç»“æœã€‚
    const results = await processor.start();
    
    console.log('\nğŸ“Š æ‰§è¡Œç»“æœ:');
    results.forEach(result => {
        console.log(`  ä»»åŠ¡ ${result.index + 1}: ${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'} - ${result.result || result.error}`);
    });
}
example1();


// // ==================== ç¤ºä¾‹ 2ï¼šæš‚åœå’Œæ¢å¤ ====================
// async function example2() {
//     console.log('\n========== ç¤ºä¾‹ 2ï¼šæš‚åœå’Œæ¢å¤ ==========\n');
    
//     const tasks = [
//         createTask(1, 1000),
//         createTask(2, 1000),
//         createTask(3, 1000),
//         createTask(4, 1000),
//         createTask(5, 1000)
//     ];
    
//     const processor = processTasks(tasks);
    
//     // å¯åŠ¨ä»»åŠ¡
//     processor.start().then(results => {
//         console.log('\nğŸ“Š æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼');
//         console.log('ç»“æœ:', results.map(r => r.result));
//     });
    
//     // 2 ç§’åæš‚åœ
//     setTimeout(() => {
//         console.log('\n--- ç”¨æˆ·è¯·æ±‚æš‚åœ ---');
//         processor.pause();
//     }, 2500);
    
//     // 5 ç§’åæ¢å¤
//     setTimeout(() => {
//         console.log('\n--- ç”¨æˆ·è¯·æ±‚æ¢å¤ ---');
//         processor.start();
//     }, 5000);
// }

// // ==================== ç¤ºä¾‹ 3ï¼šå¤„ç†ä»»åŠ¡å¤±è´¥ ====================
// async function example3() {
//     console.log('\n========== ç¤ºä¾‹ 3ï¼šå¤„ç†ä»»åŠ¡å¤±è´¥ ==========\n');
    
//     const tasks = [
//         createTask(1, 500),
//         createTask(2, 500),
//         createTask(3, 500, true),  // è¿™ä¸ªä»»åŠ¡ä¼šå¤±è´¥
//         createTask(4, 500),
//         createTask(5, 500)
//     ];
    
//     const processor = processTasks(tasks);
    
//     try {
//         await processor.start();
//     } catch (error) {
//         console.log('\nâŒ ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå¤±è´¥:', error.message);
//         console.log('ğŸ“Š å½“å‰çŠ¶æ€:', processor.getStatus());
//     }
// }

// // ==================== ç¤ºä¾‹ 4ï¼šå®é™…åº”ç”¨åœºæ™¯ - æ‰¹é‡å¤„ç†æ•°æ® ====================
// async function example4() {
//     console.log('\n========== ç¤ºä¾‹ 4ï¼šæ‰¹é‡å¤„ç†æ•°æ® ==========\n');
    
//     // æ¨¡æ‹Ÿéœ€è¦å¤„ç†çš„æ•°æ®
//     const dataList = [
//         { id: 1, name: 'ç”¨æˆ·A', email: 'a@example.com' },
//         { id: 2, name: 'ç”¨æˆ·B', email: 'b@example.com' },
//         { id: 3, name: 'ç”¨æˆ·C', email: 'c@example.com' },
//         { id: 4, name: 'ç”¨æˆ·D', email: 'd@example.com' },
//         { id: 5, name: 'ç”¨æˆ·E', email: 'e@example.com' }
//     ];
    
//     // å°†æ•°æ®å¤„ç†è½¬æ¢ä¸ºä»»åŠ¡
//     const tasks = dataList.map(data => {
//         return async () => {
//             // æ¨¡æ‹Ÿ API è°ƒç”¨
//             await new Promise(resolve => setTimeout(resolve, 800));
//             return {
//                 userId: data.id,
//                 processed: true,
//                 timestamp: new Date().toISOString()
//             };
//         };
//     });
    
//     const processor = processTasks(tasks);
//     const results = await processor.start();
    
//     console.log('\nğŸ“Š å¤„ç†ç»“æœ:');
//     results.forEach(result => {
//         console.log(`  ${JSON.stringify(result.result)}`);
//     });
// }

// // ==================== è¿è¡Œç¤ºä¾‹ ====================
// async function runExamples() {
//     // è¿è¡Œç¤ºä¾‹ 1
//     await example1();
    
//     // ç­‰å¾… 2 ç§’
//     await new Promise(resolve => setTimeout(resolve, 2000));
    
//     // è¿è¡Œç¤ºä¾‹ 2ï¼ˆéœ€è¦æ‰‹åŠ¨ç­‰å¾…å®Œæˆï¼‰
//     // await example2();
//     // await new Promise(resolve => setTimeout(resolve, 8000));
    
//     // è¿è¡Œç¤ºä¾‹ 3
//     await example3();
    
//     // ç­‰å¾… 2 ç§’
//     await new Promise(resolve => setTimeout(resolve, 2000));
    
//     // è¿è¡Œç¤ºä¾‹ 4
//     await example4();
// }
</script>
</html>